# Template file for 'dracut-ng'
pkgname=dracut-ng
version=104
revision=1
build_style=configure
configure_args="
 --prefix=/usr
 --sysconfdir=/etc
 --sbindir=/usr/bin"
hostmakedepends="pkg-config asciidoc"
makedepends="libkmod-devel"
depends="bash coreutils cpio systemd-udev gzip kmod>=3.7 kpartx util-linux"
short_desc="Event driven initramfs infrastructure"
maintainer="Duncaen <duncaen@voidlinux.org>"
license="GPL-2.0-or-later"
homepage="https://github.com/dracut-ng/dracut-ng"
changelog="https://raw.githubusercontent.com/dracut-ng/dracut-ng/master/NEWS.md"
distfiles="https://github.com/dracut-ng/dracut-ng/archive/refs/tags/${version}.tar.gz"
checksum=d5d4b8a4d8bb38bf88584937c0c487aa19849698a67caed608e893b148be9798

if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
	makedepends+=" musl-fts-devel"
fi

replaces="dracut>=0"
provides="dracut-${version}_${revision}"

alternatives="
 initramfs:/etc/kernel.d/post-install/20-initramfs:/usr/libexec/dracut/kernel-hook-postinst
 initramfs:/etc/kernel.d/post-remove/20-initramfs:/usr/libexec/dracut/kernel-hook-postrm"
conf_files="/etc/dracut.conf"
make_dirs="
 /etc/dracut.conf.d 0755 root root
 /usr/lib/dracut/dracut.conf.d 0755 root root"

subpackages="dracut-ng-network"

case "$XBPS_TARGET_MACHINE" in
	# archs supported by dracut for EFI bundle
	i686*|x86_64*|aarch64*) subpackages+=" dracut-ng-uefi" ;;
esac

post_install() {
	# kernel hooks.
	vinstall "${FILESDIR}/kernel-hook-postinst" 755 usr/libexec/dracut
	vinstall "${FILESDIR}/kernel-hook-postrm" 755 usr/libexec/dracut

	# don't need s390x architecture dependent dracut modules
	for f in 80cms 81cio_ignore 91zipl 95dasd 95dasd_mod 95dcssblk 95zfcp 95znet; do
		rm -r "${DESTDIR}/usr/lib/dracut/modules.d/${f}"
	done
}

dracut-ng-network_package() {
	short_desc+=" - network modules"
	depends="dhclient ${sourcepkg}-${version}_${revision}"
	replaces="dracut-network>=0"
	provides="dracut-netowrk-${version}_${revision}"
	pkg_install() {
		for f in 35network-legacy 40network 45url-lib 90kernel-network-modules \
			90qemu-net 90livenet 95cifs 95fcoe 95fcoe-uefi 95iscsi 95nbd 95nfs \
			95ssh-client; do
			vmove "usr/lib/dracut/modules.d/${f}"
		done
	}
}

dracut-ng-uefi_package() {
	short_desc+=" - UEFI bundle hook"
	depends="binutils systemd-boot-efistub ${sourcepkg}>=${version}_${revision}"
	replaces="dracut-uefi>=0"
	provides="dracut-uefi-${version}_${revision}"
	conf_files="/etc/default/dracut-uefi-hook"
	pkg_install() {
		vinstall "${FILESDIR}/dracut-uefi-hook.confd" 644 etc/default dracut-uefi-hook
		vinstall "${FILESDIR}/kernel-uefi-hook-postinst" 755 etc/kernel.d/post-install 20-dracut-uefi
		vinstall "${FILESDIR}/kernel-uefi-hook-postrm" 755 etc/kernel.d/post-remove 20-dracut-uefi
	}
}
